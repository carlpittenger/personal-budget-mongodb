<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <style>
            body {
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                width: 960px;
                height: 500px;
                position: relative;
            }

            svg {
                width: 100%;
                height: 100%;
            }

            path.slice {
                stroke-width: 2px;
            }

            polyline {
                opacity: 0.3;
                stroke: black;
                stroke-width: 2px;
                fill: none;
            }

            .randomize {
                position: absolute;
                top: 10px;
                right: 10px;
            }
        </style>
    </head>
    <body>
        <button type="button" class="randomize">Randomize</button>
        <svg></svg>

        <script src="https://d3js.org/d3.v3.min.js"></script>
        <script>
            const width = 960;
            const height = 500;
            const radius = Math.min(width, height) / 2;

            const svg = d3
                .select("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g");

            svg.attr("transform", `translate(${width / 2}, ${height / 2})`);

            const pieGenerator = d3.layout
                .pie()
                .sort(null)
                .value((d) => d.value);

            const arcGenerator = d3.svg
                .arc()
                .innerRadius(radius * 0.4)
                .outerRadius(radius * 0.8);

            const outerArc = d3.svg
                .arc()
                .innerRadius(radius * 0.9)
                .outerRadius(radius * 0.9);

            const color = d3.scale
                .ordinal()
                .domain([
                    "Lorem ipsum",
                    "dolor sit",
                    "amet",
                    "consectetur",
                    "adipisicing",
                    "elit",
                    "sed",
                    "do",
                    "eiusmod",
                    "tempor",
                    "incididunt",
                ])
                .range([
                    "#98abc5",
                    "#8a89a6",
                    "#7b6888",
                    "#6b486b",
                    "#a05d56",
                    "#d0743c",
                    "#ff8c00",
                ]);

            const randomizeButton = d3.select(".randomize");
            randomizeButton.on("click", () => {
                change(randomData());
            });

            function randomData() {
                const labels = color.domain();
                return labels.map((label) => ({
                    label: label,
                    value: Math.random(),
                }));
            }

            function change(data) {
                const slice = svg
                    .select(".slices")
                    .selectAll("path.slice")
                    .data(pieGenerator(data), (d) => d.data.label);

                slice
                    .enter()
                    .append("path")
                    .attr("class", "slice")
                    .style("fill", (d) => color(d.data.label));

                slice
                    .transition()
                    .duration(1000)
                    .attrTween("d", (d) => {
                        const interpolateFn = d3.interpolate(this._current, d);
                        this._current = interpolateFn(0);
                        return (t) => arcGenerator(interpolateFn(t));
                    });

                slice.exit().remove();

                const text = svg
                    .select(".labels")
                    .selectAll("text")
                    .data(pieGenerator(data), (d) => d.data.label);

                text.enter()
                    .append("text")
                    .attr("dy", ".35em")
                    .text((d) => d.data.label);

                text.transition()
                    .duration(1000)
                    .attrTween("transform", (d) => {
                        const interpolateFn = d3.interpolate(this._current, d);
                        this._current = interpolateFn(0);
                        return (t) => {
                            const d2 = interpolateFn(t);
                            const pos = outerArc.centroid(d2);
                            pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
                            return `translate(${pos})`;
                        };
                    })
                    .styleTween("text-anchor", (d) => {
                        const interpolateFn = d3.interpolate(this._current, d);
                        this._current = interpolateFn(0);
                        return (t) =>
                            midAngle(interpolateFn(t)) < Math.PI
                                ? "start"
                                : "end";
                    });

                text.exit().remove();

                const polyline = svg
                    .select(".lines")
                    .selectAll("polyline")
                    .data(pieGenerator(data), (d) => d.data.label);

                polyline.enter().append("polyline");

                polyline
                    .transition()
                    .duration(1000)
                    .attrTween("points", (d) => {
                        const interpolateFn = d3.interpolate(this._current, d);
                        this._current = interpolateFn(0);
                        return (t) => {
                            const d2 = interpolateFn(t);
                            const pos = outerArc.centroid(d2);
                            pos[0] =
                                radius *
                                0.95 *
                                (midAngle(d2) < Math.PI ? 1 : -1);
                            return [
                                arcGenerator.centroid(d2),
                                outerArc.centroid(d2),
                                pos,
                            ];
                        };
                    });

                polyline.exit().remove();
            }

            function midAngle(d) {
                return d.startAngle + (d.endAngle - d.startAngle) / 2;
            }

            function initialize() {
                svg.append("g").attr("class", "slices");
                svg.append("g").attr("class", "labels");
                svg.append("g").attr("class", "lines");
                change(randomData());
            }

            initialize();
        </script>
    </body>
</html>
